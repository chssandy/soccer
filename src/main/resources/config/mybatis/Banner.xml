<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmrz.mybatis.banner">
	<select id="getBannerList" parameterType="BannerSearch" resultType="BannerBean">
        SELECT
        	AB.banner_id,
			AB.title,
			AB.url,
			AB.img_url,
			AB.sort,
			AB.create_user,
			AB.create_time,
			AB.show_btime,
			AB.show_etime,
			AB.status,
			AB.click_nums,
			AB.uv
        FROM 
        	APP_BANNER AB
        <if test="province_code != '-1'">
	    	INNER JOIN APP_BANNER_CITY ABC ON AB.banner_id = ABC.banner_id
	    </if>
        WHERE
            AB.is_del = 0
            <if test="province_code != '-1'">
				AND (	ABC.city_level = 2 or
					(	ABC.city_code = #{province_code} and ABC.city_level = 3) or
					( 	ABC.city_code = #{city_code} and ABC.city_level = 4 )  
				) 
			</if>
    		<choose>
	    		 <when test='show_item !=null and show_item !="" and show_item =="1" '>
		    		AND AB.status = 2
			    	AND NOW() &gt;= AB.show_btime 
			    	AND NOW() &lt;= AB.show_etime  
	    		  	ORDER BY AB.banner_id desc
	     			LIMIT 8
	     		</when>
	     		<otherwise>
	     			<if test="title_search != null and title_search != ''">
	                	AND AB.title LIKE CONCAT('%',#{title_search},'%')
		            </if>
				    <if test="create_btime != null and create_btime != ''">
				    	AND AB.create_time &gt; concat(#{create_btime}," 00:00:00")
				    </if>
				    <if test="create_etime != null and create_etime != ''">
				    	AND AB.create_time &lt; concat(#{create_etime}," 23:59:59")
				    </if>
				     ORDER BY AB.banner_id desc
	     			<if test="havePage == 1">
	     				LIMIT #{start}, #{rows}
	     			</if>
	     		</otherwise>
    		</choose>
	</select>
	
	<select id="getBannerCount" parameterType="BannerSearch" resultType="int">
		 SELECT COUNT(1) FROM (
		 	   SELECT
	        	AB.banner_id
	        FROM 
	        	APP_BANNER AB
	        <if test="province_code != '-1'">
		    	INNER JOIN APP_BANNER_CITY ABC ON AB.banner_id = ABC.banner_id
		    </if>
	        WHERE
	            AB.is_del = 0
	            <if test="province_code != '-1'">
					AND (	ABC.city_level = 2 or
						(	ABC.city_code = #{province_code} and ABC.city_level = 3) or
						( 	ABC.city_code = #{city_code} and ABC.city_level = 4 )  
					) 
				</if>
			    <choose>
			    	<when test='show_item !=null and show_item !="" and show_item =="1" '>
			    		AND AB.status = 2
				    	AND NOW() &gt;= AB.show_btime 
				    	AND NOW() &lt;= AB.show_etime  
				    	LIMIT 8
			    	</when>
			    	<otherwise>
			    		<if test="title_search != null and title_search != ''">
			                AND AB.title LIKE CONCAT('%',#{title_search},'%')
			            </if>
					    <if test="create_btime != null and create_btime != ''">
					    	AND AB.create_time &gt; concat(#{create_btime}," 00:00:00")
					    </if>
					    <if test="create_etime != null and create_etime != ''">
					    	AND AB.create_time &lt; concat(#{create_etime}," 23:59:59")
					    </if>
			    	</otherwise>
			    </choose>
			    	
		 ) A
     
	</select>
	
	<insert id="addBanner" parameterType="BannerBean" useGeneratedKeys="true" keyProperty="banner_id">
        INSERT INTO APP_BANNER (
			title,
			url,
			img_url,
			sort,
			show_btime,
			show_etime,
			create_user
        )
        VALUES 
        (#{title},
         #{url},
         #{img_url},
         #{sort},
         #{show_btime},
         concat(#{show_etime}," 23:59:59"),
         #{create_user}
         )
    </insert>
    
   	<insert id="addBannerCity" parameterType="BannerBean" >
        INSERT INTO APP_BANNER_CITY(banner_id,city_code,city_level) VALUES 
        <foreach collection="cities" item="item" separator=","  index="index">
			 (#{banner_id},#{item.city_code},#{item.city_level})
        </foreach>
    </insert>
    
   	<delete id="delBannerCity" parameterType="String" >
        DELETE FROM APP_BANNER_CITY WHERE banner_id = #{banner_id}
    </delete>
    
   	<update id="updateBannerStatus" parameterType="java.util.Map">
		UPDATE APP_BANNER AB 
		<set>
			<if test="status !=null and status !='' ">
				AB.status = #{status},
			</if>
			<if test="is_del !=null and is_del !='' ">
				AB.is_del = #{is_del},
			</if>
		</set>
		WHERE AB.banner_id = #{banner_id} 
	</update>
	
	<update id="modifyBanner" parameterType="BannerBean">
        UPDATE APP_BANNER 
        <set>
            <if test="title != null and title != ''">
                title = #{title,jdbcType=VARCHAR},
            </if>
            <if test="url != null and url != ''">
                url = #{url,jdbcType=VARCHAR},
            </if>
            <if test="img_url != null and img_url != ''">
                img_url = #{img_url,jdbcType=VARCHAR},
            </if>
            <if test="show_btime != null and show_btime != ''">
                show_btime = #{show_btime,jdbcType=VARCHAR},
            </if>
            <if test="show_etime != null and show_etime != ''">
                show_etime = concat(#{show_etime,jdbcType=VARCHAR}," 23:59:59"),
            </if>
            <if test="sort != null and sort != ''">
                sort = #{sort,jdbcType=VARCHAR},
            </if>
            <if test="create_user != null and create_user != ''">
                create_user = #{create_user,jdbcType=VARCHAR},
            </if>
            <if test="create_time != null and create_time != ''">
                create_time = #{create_time,jdbcType=VARCHAR},
            </if>
        </set>
        WHERE banner_id = #{banner_id} 
    </update>
    
     <select id="getBannerById" parameterType="String" resultMap="BannerInfoMap">
    	SELECT
          AB.banner_id,
          AB.title,
          AB.url,
          DATE_FORMAT(AB.show_btime,'%Y-%m-%d') as show_btime,
          DATE_FORMAT(AB.show_etime,'%Y-%m-%d') as show_etime,
          AB.img_url,
          AB.sort,
          AB.create_user,
          AB.create_time,
          ABC.city_code,
          ABC.city_level
        FROM APP_BANNER AB
        LEFT JOIN APP_BANNER_CITY ABC ON AB.banner_id = ABC.banner_id
        WHERE AB.banner_id = #{banner_id}
    </select>
    
    <resultMap type="BannerBean" id="BannerInfoMap">
    	<id column="banner_id" property="banner_id" />
    	<result column="title" property="title"/>
    	<result column="url" property="url"/>
    	<result column="img_url" property="img_url"/>
    	<result column="sort" property="sort"/>
    	<result column="show_btime" property="show_btime" />
    	<result column="show_etime" property="show_etime" />
    	<result column="create_user" property="create_user"/>
    	<result column="create_time" property="create_time"/>
    	<collection property="cities" ofType="CityBean" >
			<result property="city_code" column="city_code" />
			<result property="city_level"  column="city_level" />
		</collection>
    </resultMap>
    
   	<update id="sortBanner" parameterType="BannerBean">
		update app_banner ab set ab.sort = #{sort}
		where ab.banner_id = #{banner_id} and NOT EXISTS(select *  from (select ab1.*  from  app_banner as ab1 where ab1.sort = #{sort} AND ab1.is_del = 0) as t) ;
	</update>
    
</mapper>